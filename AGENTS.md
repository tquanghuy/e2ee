# Context for Agents

This repository `e2ee` is a Go SDK for End-to-End Encryption. It was originally generated by an AI and follows specific conventions that MUST be maintained.

## Core Terminology

- **Identity Keys**: Ed25519 keys used for signing and long-term user identity. Never rotated.
- **Signed Prekeys** (also called Exchange Keys): X25519 keys used for ECDH key exchange and encryption. Rotated periodically following Signal Protocol patterns.
- **Prekey Bundles**: X3DH-compatible structures containing identity key and signed prekey for asynchronous key exchange.
- **Key Versioning**: Support for multiple prekey versions with lifecycle management (Active/Deprecated/Expired).
- **Encrypt/Decrypt**: The primary operations. `Seal/Open` are deprecated terms in this codebase.

## Security Model

- **Signal Protocol Compatibility**: Follows Signal Protocol's X3DH design patterns for key management.
- **Authenticated Encryption**: We use a **Sign-then-Encrypt** scheme.
    - **Encrypt**: Signs the plaintext with the sender's `IdentityKey`, then encrypts the (message + signature) using XChaCha20-Poly1305 (derived from ECDH with signed prekey).
    - **Decrypt**: Decrypts the ciphertext, then verifies the signature against the sender's `IdentityKey`.
- **Forward Secrecy**: Every message uses a fresh ephemeral key pair generated by the sender.
- **Prekey Rotation**: Signed prekeys are rotated periodically while identity keys remain stable.
- **Key Versioning**: Multiple prekey versions can coexist for backward compatibility during rotation.

## Project Structure

- Root package (`e2ee`): All core functionality including:
  - Key generation and management
  - Prekey bundles (Signal Protocol compatible)
  - Encryption, decryption, signing, and verification
  - Key rotation and versioning
  - Lifecycle management (expiration, pruning)
- `examples/`: Usage examples including key rotation demo.
- `doc.go`: Root package documentation.

## Development Rules

1.  **No Global State**: Keep packages stateless.
2.  **Secure Defaults**: Do not expose unsafe primitives (e.g., raw AES) without a high-level wrapper.
3.  **Signal Protocol Alignment**: Use standard terminology (prekeys, signed prekeys) in new code.
4.  **Backward Compatibility**: Maintain legacy method names alongside new Signal Protocol aliases.
5.  **Testing**: Always add unit tests in `_test.go` files. Run with `go test ./...`.
6.  **Formatting**: Follow standard Go formatting.

## Verification

When making changes, verify using the simple chat example:
```bash
go run examples/simple-chat/main.go
```
